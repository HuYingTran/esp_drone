{% extends "layout.html" %}
{% block content %}

<div class="container mt-3">
    <h3 class="mb-3">ğŸ” QuÃ©t Drone trong máº¡ng LAN</h3>

    <div class="card p-4 shadow-sm">
        <label for="prefix" class="fw-bold">Dáº£i máº¡ng (prefix):</label>
        <input id="prefix" class="form-control mb-3" value="{{ default_prefix }}">

        <button class="btn btn-primary w-100 mb-2" onclick="startScan()">ğŸš€ Báº¯t Ä‘áº§u quÃ©t</button>

        <button class="btn btn-outline-secondary w-100 mb-3" onclick="startScan()">ğŸ”„ QuÃ©t láº¡i</button>

        <div id="loading" class="text-center my-3" style="display:none;">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 small">Äang quÃ©t toÃ n bá»™ máº¡ng LAN, vui lÃ²ng chá»...</p>
        </div>

        <hr>

        <h5>Káº¿t quáº£ tÃ¬m tháº¥y:</h5>
        <ul id="result" class="list-group mb-3"></ul>

        {% if selected_ip %}
        <div class="alert alert-success mt-3">
            Drone Ä‘ang Ä‘Æ°á»£c chá»n:  
            <b class="text-primary">{{ selected_ip }}</b>
            <button class="btn btn-sm btn-info float-end" onclick="pingCurrentDrone()">ğŸ“¡ Kiá»ƒm tra káº¿t ná»‘i</button>
        </div>
        {% endif %}
    </div>
</div>

<script>
function startScan() {
    const prefix = document.getElementById("prefix").value;

    document.getElementById("result").innerHTML = "";
    document.getElementById("loading").style.display = "block";

    fetch(`/api/scan?prefix=${encodeURIComponent(prefix)}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById("loading").style.display = "none";
            let ul = document.getElementById("result");
            ul.innerHTML = "";

            if (!data.found || data.found.length === 0) {
                ul.innerHTML = '<li class="list-group-item text-danger">âŒ KhÃ´ng tÃ¬m tháº¥y drone nÃ o</li>';
                return;
            }

            data.found.forEach(ip => {
                let li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center";

                li.innerHTML = `
                    <span>ğŸ“¡ ${ip}</span>
                    <button class="btn btn-success btn-sm" onclick="selectDrone('${ip}')">Chá»n</button>
                `;

                ul.appendChild(li);
            });
        })
        .catch(err => {
            document.getElementById("loading").style.display = "none";
            alert("Lá»—i khi quÃ©t máº¡ng LAN!");
        });
}

function selectDrone(ip) {
    fetch("/api/select-drone", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ip})
    })
    .then(res => res.json())
    .then(data => {
         alert("ÄÃ£ chá»n drone: " + data.selected);
         location.reload();
    });
}

function pingCurrentDrone() {
    alert("ğŸ”§ Chá»©c nÄƒng kiá»ƒm tra ping cÃ³ thá»ƒ thÃªm API riÃªng /api/ping-drone náº¿u báº¡n muá»‘n!");
}
</script>

{% endblock %}
