{% extends "layout.html" %}
{% block content %}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
  #map {
    height: 300px;
    border-radius: 10px;
    margin-top: 10px;
  }
</style>

<div class="card p-3 shadow-sm">
  <h5 class="mb-3 text-primary">ğŸ“… Láº­p lá»‹ch trÃ¬nh bay</h5>

  <form method="post" class="row g-3">
    <div class="col-md-4">
      <label class="form-label">TÃªn nhiá»‡m vá»¥</label>
      <input type="text" name="name" class="form-control" placeholder="Mission name">
    </div>

    <div class="col-md-4">
      <label class="form-label">Thá»i gian cháº¡y</label>
      <input id="run_at" type="text" name="run_at" class="form-control" placeholder="Chá»n thá»i gian">
    </div>

    <div class="col-md-2">
      <label class="form-label">VÄ© Ä‘á»™</label>
      <input id="lat" type="number" name="lat" step="any" class="form-control" placeholder="Nháº¥p báº£n Ä‘á»“">
    </div>

    <div class="col-md-2">
      <label class="form-label">Kinh Ä‘á»™</label>
      <input id="lon" type="number" name="lon" step="any" class="form-control" placeholder="Nháº¥p báº£n Ä‘á»“">
    </div>

    <div class="col-md-3">
      <label class="form-label">HÃ nh Ä‘á»™ng</label>
      <select name="action" class="form-select">
        <option value="capture">Chá»¥p áº£nh</option>
        <option value="takeoff">Cáº¥t cÃ¡nh</option>
        <option value="land">Háº¡ cÃ¡nh</option>
      </select>
    </div>

    <div class="col-12">
      <button class="btn btn-primary">â• ThÃªm lá»‹ch trÃ¬nh</button>
    </div>
  </form>

  <!-- Báº¢N Äá»’ CHá»ŒN Tá»ŒA Äá»˜ -->
  <div id="map"></div>
  <div class="text-muted small mt-2 text-center">ğŸ—ºï¸ Nháº¥p chuá»™t vÃ o báº£n Ä‘á»“ Ä‘á»ƒ chá»n vá»‹ trÃ­ (vÄ© Ä‘á»™, kinh Ä‘á»™)</div>
</div>

<!-- DANH SÃCH Lá»ŠCH TRÃŒNH -->
<div class="card p-3 mt-3 shadow-sm">
  <h5 class="text-primary mb-3">ğŸ•’ Lá»‹ch trÃ¬nh sáº¯p tá»›i</h5>
  <table class="table table-sm table-striped align-middle">
    <thead>
      <tr class="text-center">
        <th>TÃªn</th><th>Thá»i gian</th><th>Vá»‹ trÃ­</th><th>HÃ nh Ä‘á»™ng</th><th>Táº¡o lÃºc</th>
      </tr>
    </thead>
    <tbody class="small">
      {% for s in schedules %}
        <tr>
          <td>{{ s[1] }}</td>
          <td>{{ s[2] }}</td>
          <td>{{ "%.6f"|format(s[3]) }}, {{ "%.6f"|format(s[4]) }}</td>
          <td>{{ s[5] }}</td>
          <td>{{ s[6] }}</td>
        </tr>
      {% else %}
        <tr><td colspan="5" class="text-center text-muted">ChÆ°a cÃ³ lá»‹ch trÃ¬nh nÃ o</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ==== SCRIPT ==== -->
<script>
/* ========== Datetime Picker ========== */
flatpickr("#run_at", {
  enableTime: true,
  dateFormat: "Y-m-d H:i",
  time_24hr: true,
  minDate: "today"
});

/* ========== Leaflet Map ========== */
var map = L.map('map').setView([21.070735, 105.383553], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

var marker = null;
map.on('click', function(e) {
  const { lat, lng } = e.latlng;
  document.getElementById('lat').value = lat.toFixed(6);
  document.getElementById('lon').value = lng.toFixed(6);
  
  if (marker) map.removeLayer(marker);
  marker = L.marker([lat, lng]).addTo(map)
    .bindPopup(`ğŸ“ ${lat.toFixed(6)}, ${lng.toFixed(6)}`).openPopup();
});
</script>
{% endblock %}
